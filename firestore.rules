/**
 * Core Philosophy: This ruleset establishes a "Public Information Portal" security model.
 * Public content collections (articles, banks, brokerages) are publicly readable.
 * All write operations to this content are disabled, anticipating an admin role.
 * User-specific data and protected content (courses) are secured based on user authentication and explicit enrollment.
 *
 * Data Structure:
 * - /articles/{articleId} - Public
 * - /banks/{bankId} - Public
 * - /brokerages/{brokerageId} - Public
 * - /courses/{courseId} - Protected content, readable only by enrolled users.
 * - /users/{userId}/enrollments/{courseId} - Enrollment records, owner-write only.
 * - /newsletter_subscriptions/{subscriptionId} - Public write-only.
 *
 * Key Security Decisions:
 * - Public Read-Only Content: To allow the app to function as a public data source, most collections are world-readable.
 * - Admin-Only Writes (Default Deny): Writes to public content are denied (`if false`) for security.
 * - Course Content Protection: Reading a `/courses/{courseId}` document is only allowed if a corresponding enrollment document exists at `/users/$(request.auth.uid)/enrollments/$(courseId)`. This is a critical security feature.
 * - Enrollment Control: Users can only write to their own enrollment subcollection. They cannot create, update, or delete enrollments for other users.
 * - Newsletter Privacy: The `/newsletter_subscriptions` collection is write-only for the public to prevent email harvesting.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isEnrolled(courseId) {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)/enrollments/$(courseId));
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Provides read-only access to articles for all users. Writes are disabled.
     */
    match /articles/{articleId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }

    /**
     * @description Provides read-only access to bank information for all users. Writes are disabled.
     */
    match /banks/{bankId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }

    /**
     * @description Provides read-only access to brokerage information for all users. Writes are disabled.
     */
    match /brokerages/{brokerageId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }

    /**
     * @description PROTECTED: Course content is only readable by users who are enrolled.
     * @path /courses/{courseId}
     * @allow (get) An authenticated and enrolled user can read the course document (including the video link).
     * @deny (list) Listing all courses is denied to prevent leaking information. Public course info should be on the app's frontend.
     * @deny (create) No user can create a course.
     * @principle Implements a "Paywall" pattern. Access to a resource is granted based on the existence of a "ticket" (enrollment doc).
     */
    match /courses/{courseId} {
      allow get: if isEnrolled(courseId);
      allow list, create, update, delete: if false; // TODO: Add admin validation for writes.
    }
    
    /**
     * @description User-specific data, including course enrollments.
     * @path /users/{userId}
     */
    match /users/{userId} {
        // Users can only access their own user document.
        allow get, update: if isOwner(userId);
        
        /**
         * @description PROTECTED: Manages a user's course enrollments.
         * @path /users/{userId}/enrollments/{courseId}
         * @allow (get, list) A user can read their own enrollment records.
         * @deny (create, update, delete) Users cannot self-enroll. This must be done server-side (e.g., after payment).
         * @principle Owner-only read access for user-private data. Write access is restricted to prevent tampering.
         */
        match /enrollments/{courseId} {
            allow get, list: if isOwner(userId);
            // Deny client-side writes to prevent users from enrolling themselves for free.
            // This operation must be handled by a trusted backend/admin process after payment.
            allow create, update, delete: if false;
        }
    }


    /**
     * @description Allows any user to subscribe to the newsletter but prevents anyone from reading
     *              or modifying subscription data to protect user privacy.
     */
    match /newsletter_subscriptions/{subscriptionId} {
      allow create: if true;
      allow get, list, update, delete: if false;
    }
  }
}
    